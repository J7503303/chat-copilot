# 空值参数处理和重置功能指南

## 概述

本指南介绍了Chat Copilot electron-client中新增的空值参数处理和重置功能，解决了切换病人时可能显示上一个病人残留信息的安全隐患。

## 功能特性

### 1. 空值参数处理

**问题**: 之前当某些URL参数没有传值或为空值时，界面不会更新该值，导致显示上一个病人的信息。

**解决方案**: 现在支持传递空值来清空对应的显示字段。

#### 示例

```bash
# 清空医生姓名和科室，但保留其他信息
GET /api/v1/navigate?page=chat&doctor_id=DOC001&doctor_name=&dept_name=&patient_name=张患者

# 结果: 医生显示为"医生DOC001"（默认格式），科室为空，患者名为"张患者"
```

### 2. 重置功能

**用途**: 退出第三方系统时，清空所有参数，避免对最后操作的病人造成误操作。

#### API端点

```bash
GET /api/v1/reset
```

#### 响应

```json
{
    "success": true,
    "message": "所有参数已重置"
}
```

## 参数处理规则

### 传递规则

| 参数状态 | 处理方式 | 界面显示 |
|---------|---------|---------|
| 未传递 | **自动清空该字段** | 清空显示（或显示默认值） |
| 传递空字符串 | 清空该字段 | 清空显示（或显示默认值） |
| 传递有效值 | 更新该字段 | 显示新值 |

> **重要更新**: 现在未传递的参数也会自动清空，确保不会显示上一个病人的残留信息。

### 默认值规则

| 字段 | 空值时的默认显示 |
|-----|----------------|
| 患者姓名 | "未知患者" |
| 医生姓名 | "医生{doctor_id}" |
| 科室名称 | 空（隐藏） |
| 床位信息 | 空（隐藏） |
| 性别年龄 | 空（隐藏） |

## 使用场景

### 场景1: 切换病人时自动清空信息

```bash
# 第一个病人的完整信息
GET /api/v1/navigate?page=chat&doctor_id=DOC001&doctor_name=张医生&dept_name=心内科&patient_name=李患者&patient_bed=101&patient_sex=男&patient_age=45

# 方式1: 切换到第二个病人，显式传递空值
GET /api/v1/navigate?page=chat&doctor_id=DOC001&doctor_name=张医生&dept_name=心内科&patient_name=王患者&patient_bed=&patient_sex=&patient_age=

# 方式2: 切换到第二个病人，不传递某些参数（推荐）
GET /api/v1/navigate?page=chat&doctor_id=DOC001&doctor_name=张医生&patient_name=王患者

# 结果: 两种方式都会清空床位、性别、年龄信息，不会显示李患者的信息
```

### 场景2: 医生换班

```bash
# 换班时清空医生信息
GET /api/v1/navigate?page=chat&doctor_id=DOC002&doctor_name=&dept_name=&patient_name=同一患者

# 结果: 医生显示为"医生DOC002"，科室清空，患者信息保留
```

### 场景3: 系统退出时完全重置

```bash
# 第三方系统退出时调用
GET /api/v1/reset

# 结果: 
# - 所有界面信息清空，回到初始状态
# - 聊天窗口被重置，清空所有聊天历史
# - 清空本地存储的所有医生聊天记录
# - 标题和状态完全重置
```

## 安全考虑

### 医疗安全

1. **避免信息混淆**: 确保切换病人时不会显示上一个病人的残留信息
2. **明确状态**: 空值和未传递值有明确区别
3. **完整重置**: 提供完整的系统重置功能

### 实现细节

1. **参数检查**: 使用`hasOwnProperty()`检查参数是否被传递
2. **空值处理**: 空字符串被视为有效的"清空"指令
3. **级联更新**: 参数更新会同步到所有相关组件

## 测试验证

使用提供的测试脚本验证功能：

```bash
# 运行测试脚本
./test-empty-params.ps1
```

测试包括：
1. 完整信息设置
2. 空值参数处理
3. 部分参数传递
4. 重置功能
5. 重置后设置

## 向后兼容性

- ✅ 现有API调用方式完全兼容
- ✅ 未传递参数的行为保持不变
- ✅ 只有显式传递空值才会清空字段
- ✅ 新增的重置端点不影响现有功能

## 总结

这个增强功能显著提高了系统的安全性和用户体验：

1. **安全性**: 防止病人信息混淆
2. **灵活性**: 支持精确的字段控制
3. **可靠性**: 提供完整的重置机制
4. **兼容性**: 保持向后兼容

建议在生产环境中使用这些功能来确保医疗信息的准确性和安全性。 