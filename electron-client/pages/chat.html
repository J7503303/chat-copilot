<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>智能聊天</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      overflow: hidden;
    }

    .webapp-container {
      width: 100%;
      height: 100vh;
      border: none;
      background: white;
    }

    .loading-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      color: #666;
      background: #f5f5f5;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0078d4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 16px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error-container {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: 'Segoe UI', sans-serif;
      color: #d13438;
      background: #f5f5f5;
      padding: 20px;
      text-align: center;
    }

    .error-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .error-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .error-message {
      font-size: 14px;
      color: #666;
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .retry-btn {
      margin-top: 16px;
      padding: 12px 24px;
      background: #0078d4;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .retry-btn:hover {
      background: #106ebe;
    }

    .start-webapp-btn {
      margin-left: 12px;
      padding: 12px 24px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .start-webapp-btn:hover {
      background: #059669;
    }

    .status-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 20px;
      font-size: 12px;
      z-index: 1000;
      display: none;
    }

    .status-indicator.success {
      background: rgba(16, 185, 129, 0.9);
    }

    .status-indicator.error {
      background: rgba(209, 52, 56, 0.9);
    }

    .status-indicator.warning {
      background: rgba(245, 158, 11, 0.9);
    }
  </style>
</head>

<body>
  <!-- 状态指示器 -->
  <div id="statusIndicator" class="status-indicator"></div>

  <!-- 加载状态 -->
  <div id="loadingContainer" class="loading-container">
    <div class="loading-spinner"></div>
    <div>正在加载聊天界面...</div>
  </div>

  <!-- 错误状态 -->
  <div id="errorContainer" class="error-container">
    <div class="error-icon">⚠️</div>
    <div class="error-title">无法连接到聊天服务</div>
    <div class="error-message">
      请确保 webapp 服务正在运行在 http://localhost:8440<br>
      您可以手动启动 webapp 服务，或者点击下方按钮自动启动
    </div>
    <div>
      <button class="retry-btn" onclick="retryConnection()">重试连接</button>
      <button class="start-webapp-btn" onclick="startWebappService()">启动 Webapp</button>
    </div>
    <div style="margin-top: 20px; font-size: 12px; color: #999;">
      重试次数: <span id="retryCount">0</span> / 3
    </div>
  </div>

  <!-- webapp iframe -->
  <iframe id="webappFrame" class="webapp-container" src="" style="display: none;" onload="handleIframeLoad()"
    onerror="handleIframeError()">
  </iframe>

  <script>
    let retryCount = 0;
    const maxRetries = 3;
    let webappCheckInterval = null;

    // 显示状态指示器
    function showStatus(message, type = 'info', duration = 3000) {
      const indicator = document.getElementById('statusIndicator');
      indicator.textContent = message;
      indicator.className = `status-indicator ${type}`;
      indicator.style.display = 'block';

      if (duration > 0) {
        setTimeout(() => {
          indicator.style.display = 'none';
        }, duration);
      }
    }

    function handleIframeLoad() {
      console.log('Webapp 加载成功');
      showStatus('聊天界面加载成功', 'success');

      // 隐藏加载状态，显示iframe
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('errorContainer').style.display = 'none';
      document.getElementById('webappFrame').style.display = 'block';

      // 重置重试计数
      retryCount = 0;
      updateRetryCount();

      // 清除检查定时器
      if (webappCheckInterval) {
        clearInterval(webappCheckInterval);
        webappCheckInterval = null;
      }

      // 传递上下文信息到webapp
      setTimeout(() => {
        sendContextToWebapp();
      }, 1000);
    }

    function handleIframeError() {
      console.error('Webapp 加载失败');
      showError();
    }

    function showError() {
      document.getElementById('loadingContainer').style.display = 'none';
      document.getElementById('webappFrame').style.display = 'none';
      document.getElementById('errorContainer').style.display = 'flex';
      updateRetryCount();
      showStatus('连接失败', 'error', 0);
    }

    function updateRetryCount() {
      document.getElementById('retryCount').textContent = retryCount;
    }

    function retryConnection() {
      if (retryCount < maxRetries) {
        retryCount++;
        console.log(`重试连接 webapp (${retryCount}/${maxRetries})`);
        showStatus(`正在重试连接... (${retryCount}/${maxRetries})`, 'warning', 0);

        // 重置状态
        document.getElementById('errorContainer').style.display = 'none';
        document.getElementById('loadingContainer').style.display = 'flex';

        // 重新加载iframe
        const iframe = document.getElementById('webappFrame');
        iframe.src = buildWebappUrl() + '&retry=' + retryCount + '&t=' + Date.now();
        updateRetryCount();
      } else {
        showStatus('重试次数已达上限', 'error');
        alert('连接失败次数过多，请检查 webapp 服务是否正常运行\n\n请在终端中运行以下命令启动服务：\ncd webapp\nyarn install\nyarn start');
      }
    }

    function startWebappService() {
      showStatus('正在尝试启动 Webapp 服务...', 'warning', 0);

      // 通知主进程启动webapp服务
      if (window.electronAPI && window.electronAPI.startWebappService) {
        window.electronAPI.startWebappService()
          .then(result => {
            if (result.success) {
              showStatus('Webapp 服务启动成功，正在连接...', 'success');
              setTimeout(() => {
                retryConnection();
              }, 3000);
            } else {
              showStatus('启动失败: ' + result.error, 'error');
            }
          })
          .catch(error => {
            showStatus('启动失败: ' + error.message, 'error');
          });
      } else {
        // 如果没有API支持，提供手动启动指导
        alert('请手动启动 webapp 服务：\n\n1. 打开终端\n2. 进入 webapp 目录\n3. 运行 yarn install\n4. 运行 yarn start\n5. 等待服务启动后点击重试');
      }
    }

    // 向webapp传递上下文信息
    function sendContextToWebapp() {
      const iframe = document.getElementById('webappFrame');
      if (iframe && iframe.contentWindow) {
        try {
          // 获取父页面的上下文信息
          const contextInfo = getContextInfo();

          // 发送消息到webapp
          iframe.contentWindow.postMessage({
            type: 'CONTEXT_UPDATE',
            data: contextInfo
          }, 'http://localhost:8440');

          console.log('上下文信息已发送到webapp:', contextInfo);
          showStatus('上下文信息已同步', 'success');
        } catch (error) {
          console.warn('发送上下文信息失败:', error);
        }
      }
    }

    // 存储当前的导航参数
    let currentNavigationParams = null;

    // 获取上下文信息
    function getContextInfo() {
      try {
        // 尝试从父窗口获取上下文信息
        if (window.parent && window.parent.getContextInfo) {
          return window.parent.getContextInfo();
        }

        // 使用导航参数构建上下文信息
        if (currentNavigationParams && currentNavigationParams.params) {
          const { doctor, department, patient } = currentNavigationParams.params;
          return {
            doctorId: doctor?.id || doctor?.code || '',
            doctorName: doctor?.name || '医生',
            deptId: department?.id || department?.code || '',
            deptName: department?.name || '',
            patientId: patient?.id || '',
            patientName: patient?.name || '未知患者',
            patientBed: patient?.bed || '',
            patientSex: patient?.sex || '',
            patientAge: patient?.age || '',
            source: 'electron-app',
            timestamp: new Date().toISOString()
          };
        }

        // 如果无法获取，返回默认信息
        return {
          doctorId: '',
          doctorName: '医生',
          deptName: '',
          patientName: '未知患者',
          source: 'electron-app',
          timestamp: new Date().toISOString()
        };
      } catch (error) {
        console.warn('获取上下文信息失败:', error);
        return {
          source: 'electron-app',
          timestamp: new Date().toISOString()
        };
      }
    }

    // 监听来自webapp的消息
    window.addEventListener('message', function (event) {
      // 验证消息来源
      if (event.origin !== 'http://localhost:8440') {
        console.warn('收到未授权来源的消息:', event.origin);
        return;
      }

      console.log('收到webapp消息:', event.data);

      const { type, data } = event.data;

      switch (type) {
        case 'WEBAPP_READY':
          console.log('Webapp 已准备就绪');
          showStatus('聊天服务已就绪', 'success');
          sendContextToWebapp();
          break;

        case 'NAVIGATE_REQUEST':
          // webapp请求导航到其他页面
          console.log('Webapp 请求导航到:', data.page);
          if (window.parent && window.parent.switchPage) {
            window.parent.switchPage(data.page);
          }
          break;

        case 'CONTEXT_REQUEST':
          // webapp请求上下文信息
          console.log('Webapp 请求上下文信息');
          sendContextToWebapp();
          break;

        case 'ERROR':
          // webapp报告错误
          console.error('Webapp 报告错误:', data);
          showStatus('聊天服务错误: ' + data.message, 'error');
          break;

        case 'STATUS':
          // webapp状态更新
          console.log('Webapp 状态更新:', data);
          showStatus(data.message, data.type || 'info');
          break;
      }
    });

    // 页面卸载时的清理
    window.addEventListener('beforeunload', function () {
      console.log('Chat页面即将卸载');
      if (webappCheckInterval) {
        clearInterval(webappCheckInterval);
      }
    });

    // 构建webapp URL
    function buildWebappUrl() {
      const baseUrl = 'http://localhost:8440/doctor-chat.html';
      const params = new URLSearchParams();

      if (currentNavigationParams && currentNavigationParams.params) {
        const { doctor, department, patient } = currentNavigationParams.params;


        // 添加医生信息
        if (doctor?.id) params.append('doctor_id', doctor.id);
        if (doctor?.code) params.append('doctor_code', doctor.code);
        if (doctor?.name) params.append('doctor_name', doctor.name);

        // 添加科室信息
        if (department?.id) params.append('dept_id', department.id);
        if (department?.code) params.append('dept_code', department.code);
        if (department?.name) params.append('dept_name', department.name);

        // 添加患者信息
        if (patient?.id) params.append('patient_id', patient.id);
        if (patient?.name) params.append('patient_name', patient.name);
        if (patient?.bed) params.append('patient_bed', patient.bed);
        if (patient?.sex) params.append('patient_sex', patient.sex);
        if (patient?.age) params.append('patient_age', patient.age);
      } else {

        // 如果没有参数，添加默认值
        params.append('doctor_id', 'doctor_001');
        params.append('doctor_name', '张医生');
        params.append('dept_name', '心内科');
      }

      const queryString = params.toString();
      const finalUrl = queryString ? `${baseUrl}?${queryString}` : baseUrl;

      return finalUrl;
    }

    // 检查webapp服务可用性
    function checkWebappService() {
      return fetch('http://localhost:8440', {
        method: 'GET',
        mode: 'no-cors', // 避免CORS问题
        cache: 'no-cache'
      })
        .then(response => {
          console.log('Webapp 服务检查成功');
          return true;
        })
        .catch(error => {
          console.log('Webapp 服务不可用:', error.message);
          return false;
        });
    }

    // 定期检查webapp服务状态
    function startWebappHealthCheck() {
      webappCheckInterval = setInterval(async () => {
        const isAvailable = await checkWebappService();
        if (!isAvailable && document.getElementById('webappFrame').style.display === 'block') {
          console.warn('Webapp 服务意外中断');
          showStatus('聊天服务连接中断', 'error');
          showError();
        }
      }, 30000); // 每30秒检查一次
    }

    // 初始化
    async function initialize() {
      console.log('Chat page initializing...');
      showStatus('正在连接聊天服务...', 'warning', 0);

      // 设置iframe的初始URL
      const iframe = document.getElementById('webappFrame');
      const initialUrl = buildWebappUrl();
      iframe.src = initialUrl;

      // 启动webapp通信监听
      setupWebappCommunication();

      // 初始检查webapp服务
      setTimeout(async () => {
        const isAvailable = await checkWebappService();
        if (!isAvailable) {
          console.error('初始检查: Webapp 服务不可用');
          setTimeout(showError, 1000); // 1秒后显示错误
        } else {
          console.log('初始检查: Webapp 服务可用');
          // 启动健康检查
          startWebappHealthCheck();
        }
      }, 1000);
    }

    // 监听来自主进程的导航参数
    if (window.electronAPI && window.electronAPI.onNavigationParams) {
      console.log('Navigation params listener registered');
      window.electronAPI.onNavigationParams((params) => {

        currentNavigationParams = params;

        // 重新加载iframe以应用新参数
        const iframe = document.getElementById('webappFrame');
        const newUrl = buildWebappUrl();

        iframe.src = newUrl;
      });
    } else {
      console.warn('electronAPI or onNavigationParams unavailable');
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', initialize);

    // 监听来自webapp的URL变化通知
    function setupWebappCommunication() {
      // 监听来自webapp的消息
      window.addEventListener('message', (event) => {
        // 处理来自main-layout的重置消息
        if (event.data && event.data.type === 'RESET') {
          console.log('收到重置消息，转发给webapp');
          const iframe = document.getElementById('webappFrame');
          if (iframe && iframe.contentWindow) {
            try {
              iframe.contentWindow.postMessage({
                type: 'RESET'
              }, 'http://localhost:8440');
            } catch (e) {
              // 忽略错误
            }
          }
          return;
        }

        // 确保消息来自webapp
        if (event.origin !== 'http://localhost:8440') {
          return;
        }

        if (event.data && event.data.type === 'URL_CHANGED') {
          console.log('收到webapp URL变化通知:', event.data);

          const urlData = event.data.data;
          if (urlData && urlData.params) {
            // 构建新的导航参数
            const newNavigationParams = {
              page: 'chat',
              params: {
                doctor: {
                  id: urlData.params.doctor_id,
                  code: urlData.params.doctor_code,
                  name: urlData.params.doctor_name
                },
                department: {
                  id: urlData.params.dept_id,
                  code: urlData.params.dept_code,
                  name: urlData.params.dept_name
                },
                patient: {
                  id: urlData.params.patient_id,
                  name: urlData.params.patient_name,
                  bed: urlData.params.patient_bed,
                  sex: urlData.params.patient_sex,
                  age: urlData.params.patient_age
                }
              },
              timestamp: new Date().toISOString()
            };

            // 清理空值
            Object.keys(newNavigationParams.params).forEach(key => {
              const obj = newNavigationParams.params[key];
              Object.keys(obj).forEach(subKey => {
                if (!obj[subKey]) {
                  delete obj[subKey];
                }
              });
              if (Object.keys(obj).length === 0) {
                delete newNavigationParams.params[key];
              }
            });

            // 更新当前导航参数
            currentNavigationParams = newNavigationParams;
            console.log('更新导航参数:', newNavigationParams);

            // 通知主布局更新上下文信息
            if (window.parent && window.parent.mainLayout) {
              const contextInfo = {};
              if (newNavigationParams.params.doctor) {
                if (newNavigationParams.params.doctor.id) contextInfo.doctorId = newNavigationParams.params.doctor.id;
                if (newNavigationParams.params.doctor.code) contextInfo.doctorCode = newNavigationParams.params.doctor.code;
                if (newNavigationParams.params.doctor.name) contextInfo.doctorName = newNavigationParams.params.doctor.name;
              }
              if (newNavigationParams.params.department) {
                if (newNavigationParams.params.department.id) contextInfo.deptId = newNavigationParams.params.department.id;
                if (newNavigationParams.params.department.code) contextInfo.deptCode = newNavigationParams.params.department.code;
                if (newNavigationParams.params.department.name) contextInfo.deptName = newNavigationParams.params.department.name;
              }
              if (newNavigationParams.params.patient) {
                if (newNavigationParams.params.patient.id) contextInfo.patientId = newNavigationParams.params.patient.id;
                if (newNavigationParams.params.patient.name) contextInfo.patientName = newNavigationParams.params.patient.name;
                if (newNavigationParams.params.patient.bed) contextInfo.patientBed = newNavigationParams.params.patient.bed;
                if (newNavigationParams.params.patient.sex) contextInfo.patientSex = newNavigationParams.params.patient.sex;
                if (newNavigationParams.params.patient.age) contextInfo.patientAge = newNavigationParams.params.patient.age;
              }

              window.parent.mainLayout.setContextInfo(contextInfo);
              console.log('已通知主布局更新上下文信息');
            }
          }
        }
      });

      console.log('webapp通信监听已启动');
    }

    // 对外接口 - 供第三方系统调用
    window.ChatIntegration = {
      // 发送消息到webapp
      sendMessage: function (message, context = {}) {
        const iframe = document.getElementById('webappFrame');
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.postMessage({
            type: 'SEND_MESSAGE',
            data: { message, context }
          }, 'http://localhost:8440');
          return { success: true, message: '消息已发送' };
        }
        return { success: false, error: 'Webapp 未就绪' };
      },

      // 更新上下文信息
      updateContext: function (contextInfo) {
        sendContextToWebapp();
        return { success: true, message: '上下文已更新' };
      },

      // 获取webapp状态
      getStatus: function () {
        const iframe = document.getElementById('webappFrame');
        return {
          loaded: iframe && iframe.style.display === 'block',
          retryCount: retryCount,
          maxRetries: maxRetries
        };
      },

      // 手动重试连接
      retry: function () {
        retryConnection();
        return { success: true, message: '正在重试连接' };
      }
    };

    console.log('Chat page loaded, integration interface ready');

    // 实现setContextInfo函数，供main-layout.html调用
    window.setContextInfo = function (contextInfo) {
      if (contextInfo) {
        // 将上下文信息转换为导航参数格式，保留空值用于清空显示
        const navigationParams = {
          page: 'chat',
          params: {
            doctor: {},
            department: {},
            patient: {}
          },
          timestamp: new Date().toISOString()
        };

        // 医生信息 - 包括空值
        if (contextInfo.hasOwnProperty('doctorId')) navigationParams.params.doctor.id = contextInfo.doctorId || '';
        if (contextInfo.hasOwnProperty('doctorCode')) navigationParams.params.doctor.code = contextInfo.doctorCode || '';
        if (contextInfo.hasOwnProperty('doctorName')) navigationParams.params.doctor.name = contextInfo.doctorName || '';

        // 科室信息 - 包括空值
        if (contextInfo.hasOwnProperty('deptId')) navigationParams.params.department.id = contextInfo.deptId || '';
        if (contextInfo.hasOwnProperty('deptCode')) navigationParams.params.department.code = contextInfo.deptCode || '';
        if (contextInfo.hasOwnProperty('deptName')) navigationParams.params.department.name = contextInfo.deptName || '';

        // 患者信息 - 包括空值
        if (contextInfo.hasOwnProperty('patientId')) navigationParams.params.patient.id = contextInfo.patientId || '';
        if (contextInfo.hasOwnProperty('patientName')) navigationParams.params.patient.name = contextInfo.patientName || '';
        if (contextInfo.hasOwnProperty('patientBed')) navigationParams.params.patient.bed = contextInfo.patientBed || '';
        if (contextInfo.hasOwnProperty('patientSex')) navigationParams.params.patient.sex = contextInfo.patientSex || '';
        if (contextInfo.hasOwnProperty('patientAge')) navigationParams.params.patient.age = contextInfo.patientAge || '';

        // 清理空对象
        Object.keys(navigationParams.params).forEach(key => {
          if (Object.keys(navigationParams.params[key]).length === 0) {
            delete navigationParams.params[key];
          }
        });

        // 更新currentNavigationParams并重新加载iframe
        currentNavigationParams = navigationParams;
        const iframe = document.getElementById('webappFrame');
        if (iframe) {
          const newUrl = buildWebappUrl();
          iframe.src = newUrl;
        }
      }
    };
  </script>
</body>

</html>